# SceneBlueprint 测试框架与质量保证

## 1. 测试分层策略

### 1.1 测试金字塔

```
    ┌─────────────────────┐
    │   E2E 端到端测试      │  少量，高价值场景
    │   Integration Tests │
    └─────────────────────┘
           ┌─────────────────────┐
           │   集成测试           │  中等数量，组件协作
           │   Component Tests   │
           └─────────────────────┘
                  ┌─────────────────────┐
                  │   单元测试           │  大量，快速验证
                  │   Unit Tests        │
                  └─────────────────────┘
```

### 1.2 测试分类

#### **单元测试 (Unit Tests)**
- **目标**: 验证单个类/方法的功能正确性
- **特点**: 快速、独立、可重复
- **覆盖**: Core 层所有公共 API
- **命名**: `{ClassName}Tests.cs`

#### **集成测试 (Integration Tests)**
- **目标**: 验证多个组件协作功能
- **特点**: 涉及多个类的交互
- **覆盖**: Actions 层与 Core 层的协作
- **命名**: `{Domain}ActionTests.cs`

#### **端到端测试 (E2E Tests)**
- **目标**: 验证完整用户场景
- **特点**: 模拟真实使用流程
- **覆盖**: 从 AutoDiscover 到序列化的完整链路
- **命名**: `EndToEndTests.cs`

## 2. 测试目录结构

```
Assets/Extensions/SceneBlueprint/Tests/
├── Unit/                          # 单元测试
│   ├── Core/
│   │   ├── ActionDefinitionTests.cs
│   │   ├── PropertyBagTests.cs
│   │   ├── ActionRegistryTests.cs
│   │   ├── PropFactoryTests.cs
│   │   ├── PropertyBagSerializerTests.cs
│   │   └── VisibleWhenEvaluatorTests.cs
│   └── Utils/                     # 测试工具类
│       ├── TestDataBuilder.cs
│       └── AssertionExtensions.cs
├── Integration/                   # 集成测试
│   ├── FlowActionTests.cs
│   ├── CombatActionTests.cs
│   └── CrossDomainTests.cs
├── E2E/                          # 端到端测试
│   ├── EndToEndTests.cs
│   └── PerformanceTests.cs
├── TestData/                     # 测试数据
│   ├── SampleActions.json
│   └── TestConfigs/
└── Scripts/                      # 测试脚本
    ├── RunAllTests.cs
    ├── TestReporter.cs
    └── CoverageAnalyzer.cs
```

## 3. 测试命名约定

### 3.1 测试类命名
- 单元测试: `{ClassName}Tests`
- 集成测试: `{Domain}IntegrationTests` 或 `{Feature}Tests`
- E2E测试: `{Scenario}E2ETests`

### 3.2 测试方法命名
使用 `Given_When_Then` 模式或 `MethodName_Scenario_Expected` 模式：

```csharp
// 推荐格式 1: Given_When_Then
[Test] public void GivenEmptyBag_WhenGetMissingKey_ThenReturnsDefault()

// 推荐格式 2: Method_Scenario_Expected  
[Test] public void Get_MissingKey_ReturnsTypeDefault()

// 推荐格式 3: 行为描述（当前使用）
[Test] public void GetMissing_ReturnsDefault()
```

## 4. 测试标准和最佳实践

### 4.1 测试编写原则

#### **FIRST 原则**
- **Fast**: 快速执行
- **Independent**: 测试间独立
- **Repeatable**: 可重复执行
- **Self-Validating**: 自验证结果
- **Timely**: 及时编写

#### **AAA 模式**
```csharp
[Test]
public void ActionRegistry_Register_CanRetrieveByTypeId()
{
    // Arrange - 准备测试数据
    var registry = new ActionRegistry();
    var def = new ActionDefinition { TypeId = "Test.Action" };
    
    // Act - 执行被测试的操作
    registry.Register(def);
    
    // Assert - 验证结果
    Assert.IsTrue(registry.TryGet("Test.Action", out var result));
    Assert.AreEqual("Test.Action", result.TypeId);
}
```

### 4.2 断言标准

#### **富有表现力的断言**
```csharp
// ❌ 不清晰
Assert.IsTrue(result);

// ✅ 清晰明确
Assert.IsTrue(registry.TryGet("Flow.Start", out _), "Flow.Start 应该被注册");

// ✅ 使用具体消息
Assert.AreEqual("Flow.Start", def.TypeId, $"期望 TypeId 为 Flow.Start，实际为 {def.TypeId}");
```

#### **边界条件测试**
```csharp
[Test] public void PropertyBag_Get_NullKey_ThrowsArgumentException()
[Test] public void PropertyBag_Get_EmptyKey_ReturnsDefault()
[Test] public void PropertyBag_Set_MaxValue_DoesNotOverflow()
```

### 4.3 测试数据管理

#### **测试数据构建器**
```csharp
public class TestDataBuilder
{
    public static ActionDefinition CreateSpawnAction(string typeId = "Test.Spawn") =>
        new ActionDefinition
        {
            TypeId = typeId,
            Category = "Test",
            Properties = new[] { Prop.Int("count", "数量", defaultValue: 5) }
        };
        
    public static PropertyBag CreatePropertyBag(params (string key, object value)[] values)
    {
        var bag = new PropertyBag();
        foreach (var (key, value) in values)
            bag.Set(key, value);
        return bag;
    }
}
```

## 5. 自动化测试流程

### 5.1 本地开发流程

1. **开发前** - 编写失败的测试（TDD）
2. **开发中** - 频繁运行相关测试
3. **开发后** - 运行完整测试套件
4. **提交前** - 运行所有测试 + 代码覆盖率检查

### 5.2 CI/CD 集成

#### **Git Hook 集成**
- **pre-commit**: 运行修改文件的相关测试
- **pre-push**: 运行完整测试套件

#### **持续集成流程**
```yaml
# .github/workflows/tests.yml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run Unit Tests
        run: ./Scripts/RunTests.sh unit
      - name: Run Integration Tests  
        run: ./Scripts/RunTests.sh integration
      - name: Generate Coverage Report
        run: ./Scripts/GenerateCoverage.sh
      - name: Upload Coverage
        uses: codecov/codecov-action@v1
```

## 6. 质量门禁标准

### 6.1 代码覆盖率要求

- **Core 模块**: ≥ 90% 行覆盖率
- **Actions 模块**: ≥ 85% 行覆盖率  
- **整体项目**: ≥ 80% 行覆盖率
- **新增代码**: 100% 覆盖率

### 6.2 测试通过标准

- 所有单元测试必须通过
- 所有集成测试必须通过
- 至少一个 E2E 测试覆盖主要功能
- 无测试代码的 Warning 或 Error

### 6.3 性能标准

- 单元测试套件执行时间 < 30 秒
- 集成测试套件执行时间 < 2 分钟
- E2E 测试套件执行时间 < 5 分钟

## 7. 测试工具和框架

### 7.1 Unity Test Framework
- **NUnit**: 断言和测试结构
- **Unity Test Runner**: 测试执行器
- **Unity TestTools**: Unity 专用测试工具

### 7.2 扩展工具
- **Moq**: Mock 框架（如需要）
- **AutoFixture**: 测试数据生成（如需要）
- **FluentAssertions**: 更好的断言语法（如需要）

## 8. 测试数据和环境

### 8.1 测试数据策略
- **内嵌数据**: 简单测试用例
- **外部文件**: 复杂 JSON 数据
- **数据构建器**: 动态生成测试数据
- **共享装置**: 可复用的测试设置

### 8.2 测试隔离
- 每个测试独立创建对象
- 不依赖测试执行顺序
- 清理测试产生的副作用

## 9. 持续改进

### 9.1 测试指标监控
- **覆盖率趋势**: 监控覆盖率变化
- **测试执行时间**: 优化慢速测试
- **失败率统计**: 识别不稳定测试
- **缺陷密度**: 测试有效性评估

### 9.2 定期回顾
- **月度**: 测试覆盖率和质量回顾
- **季度**: 测试策略和框架优化
- **发版前**: 完整质量门禁检查

## 10. 开发者指南

### 10.1 新功能开发流程

1. **分析需求** → 确定测试场景
2. **设计测试** → 编写测试用例大纲  
3. **编写测试** → 实现失败的测试
4. **实现功能** → 让测试通过
5. **重构优化** → 保持测试通过
6. **集成验证** → 运行完整测试套件

### 10.2 Bug 修复流程

1. **重现 Bug** → 编写失败的测试
2. **修复 Bug** → 让测试通过
3. **回归测试** → 确保不影响其他功能
4. **补充测试** → 覆盖相关边界情况

---

**建议**: 从当前的测试基础开始，逐步重构和完善测试框架，确保每个阶段都有可用的测试套件。
